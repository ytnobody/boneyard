name: Module Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'index/**'

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find meta.toml in PR
        id: find
        run: |
          META_FILE=$(git diff --name-only origin/main...HEAD | grep 'meta.toml' | head -1)

          if [[ -z "$META_FILE" ]]; then
            echo "No meta.toml found in PR"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "meta_file=$META_FILE" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: Extract info and fetch code
        if: steps.find.outputs.found == 'true'
        id: fetch
        run: |
          META_FILE="${{ steps.find.outputs.meta_file }}"

          # Extract fields from meta.toml
          SOURCE_URL=$(grep '^source_url = ' "$META_FILE" | sed 's/^source_url = "\(.*\)"$/\1/' || echo "")
          ENTRY=$(grep '^entry = ' "$META_FILE" | sed 's/^entry = "\(.*\)"$/\1/' || echo "mod.ca")
          LICENSE=$(grep '^license = ' "$META_FILE" | sed 's/^license = "\(.*\)"$/\1/' || echo "")
          NAME=$(grep '^name = ' "$META_FILE" | sed 's/^name = "\(.*\)"$/\1/')
          AUTHOR=$(grep '^author = ' "$META_FILE" | sed 's/^author = "\(.*\)"$/\1/')

          echo "license=$LICENSE" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT

          # Fetch source code
          if [[ -n "$SOURCE_URL" ]]; then
            RAW_URL=$(echo "$SOURCE_URL" | sed 's|github.com|raw.githubusercontent.com|')
            curl -fsSL "${RAW_URL}/main/${ENTRY}" -o module_code.ca 2>/dev/null || \
            curl -fsSL "${RAW_URL}/master/${ENTRY}" -o module_code.ca 2>/dev/null || \
            echo ""

            if [[ -s module_code.ca ]]; then
              echo "fetch_success=true" >> $GITHUB_OUTPUT
            else
              echo "fetch_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "fetch_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Security Check
        if: steps.fetch.outputs.fetch_success == 'true'
        id: security
        run: |
          ISSUES=""
          WARNINGS=""

          # Check for dangerous patterns
          if grep -qE '(os\.exec|system\(|eval\(|exec\()' module_code.ca 2>/dev/null; then
            ISSUES="${ISSUES}- ❌ Dangerous: Found potential command execution\n"
          fi

          if grep -qE '(env\[|getenv|ENV\.)' module_code.ca 2>/dev/null; then
            WARNINGS="${WARNINGS}- ⚠️ Warning: Accesses environment variables\n"
          fi

          if grep -qE 'http\.(get|post|put|delete|request)' module_code.ca 2>/dev/null; then
            WARNINGS="${WARNINGS}- ⚠️ Warning: Makes HTTP requests\n"
          fi

          if grep -qE '(io\.write_file|io\.read_file)' module_code.ca 2>/dev/null; then
            WARNINGS="${WARNINGS}- ⚠️ Warning: Performs file I/O operations\n"
          fi

          if grep -qE '(base64|decode|encode).*exec' module_code.ca 2>/dev/null; then
            ISSUES="${ISSUES}- ❌ Dangerous: Possible encoded execution\n"
          fi

          if [[ -n "$ISSUES" ]]; then
            echo "status=critical" >> $GITHUB_OUTPUT
          elif [[ -n "$WARNINGS" ]]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "status=safe" >> $GITHUB_OUTPUT
          fi

          # Store for later use
          echo "SECURITY_ISSUES<<EOF" >> $GITHUB_ENV
          echo -e "$ISSUES$WARNINGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: License Check
        id: license
        run: |
          LICENSE="${{ steps.fetch.outputs.license }}"
          VALID_LICENSES="MIT|Apache-2.0|BSD-2-Clause|BSD-3-Clause|GPL-2.0|GPL-3.0|LGPL-2.1|LGPL-3.0|MPL-2.0|ISC|Unlicense"

          if [[ -z "$LICENSE" ]]; then
            echo "status=missing" >> $GITHUB_OUTPUT
            echo "details=No license specified" >> $GITHUB_OUTPUT
          elif echo "$LICENSE" | grep -qE "^($VALID_LICENSES)$"; then
            echo "status=valid" >> $GITHUB_OUTPUT
            echo "details=$LICENSE" >> $GITHUB_OUTPUT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "details=$LICENSE (not a recognized SPDX identifier)" >> $GITHUB_OUTPUT
          fi

      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Post Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const securityStatus = '${{ steps.security.outputs.status }}';
            const licenseStatus = '${{ steps.license.outputs.status }}';
            const licenseDetails = '${{ steps.license.outputs.details }}';
            const securityIssues = process.env.SECURITY_ISSUES || 'None detected';
            const fetchSuccess = '${{ steps.fetch.outputs.fetch_success }}';

            let verdict = 'APPROVE';
            let verdictEmoji = '✅';

            if (securityStatus === 'critical' || licenseStatus === 'missing') {
              verdict = 'REQUEST_CHANGES';
              verdictEmoji = '❌';
            } else if (securityStatus === 'warning' || licenseStatus === 'unknown') {
              verdict = 'COMMENT';
              verdictEmoji = '⚠️';
            }

            const securityEmoji = securityStatus === 'safe' ? '✅' : securityStatus === 'warning' ? '⚠️' : '❌';
            const licenseEmoji = licenseStatus === 'valid' ? '✅' : licenseStatus === 'unknown' ? '⚠️' : '❌';

            let body = `## ${verdictEmoji} Module Review

            | Check | Status | Details |
            |-------|--------|---------|
            | Security | ${securityEmoji} ${securityStatus} | ${securityIssues.trim() || 'No issues detected'} |
            | License | ${licenseEmoji} ${licenseStatus} | ${licenseDetails} |
            | Source | ${fetchSuccess === 'true' ? '✅' : '❌'} | ${fetchSuccess === 'true' ? 'Code fetched successfully' : 'Could not fetch source code'} |

            ---
            *Automated review by Boneyard*`;

            // Use separate reviewer account to approve/request changes
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: verdict,
              body: body
            });
